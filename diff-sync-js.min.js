/**
 * Minified by jsDelivr using Terser v5.19.2.
 * Original file: /npm/diff-sync-js@1.0.6/lib/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw i}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}module.exports=function(){function e(t){var r=t.jsonpatch,n=t.thisVersion,o=t.senderVersion,i=t.useBackup,a=void 0===i||i,s=t.debug,l=void 0!==s&&s;if(_classCallCheck(this,e),!r)throw"jsonpatch instance is required";this.jsonpatch=r,this.thisVersion=n,this.senderVersion=o,this.useBackup=a,this.debug=l}return _createClass(e,[{key:"log",value:function(){if(this.debug){for(var e,t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];(e=console).debug.apply(e,["DIFF SYNC- "].concat(r))}}},{key:"initObject",value:function(e,t){var r,n,o=this.jsonpatch,i=this.thisVersion,a=this.senderVersion,s=this.useBackup;null!=t?(e.shadow=(_defineProperty(r={},i,0),_defineProperty(r,a,0),_defineProperty(r,"value",o.deepClone(t)),_defineProperty(r,"edits",[]),r),s&&(e.backup=(_defineProperty(n={},i,0),_defineProperty(n,a,0),_defineProperty(n,"value",o.deepClone(t)),n))):(e.shadow={},e.backup={})}},{key:"onReceive",value:function(e){var t=e.payload,r=e.container,n=e.onUpdateMain,o=e.afterUpdate,i=e.onUpdateShadow,a=this.jsonpatch,s=this.thisVersion,l=this.senderVersion,u=this.useBackup,c=r.shadow,h=r.backup;if(this.log("****************"),this.log("--RECEIVED PAYLOAD --"),this.log(s+": "+t[s]),this.log(l+": ",t.edits),this.log("-- CURRENT SHADOW --"),this.log(c),u&&c[s]!==t[s]){if(this.log("-- NOT MATCH --"),this.log("backup: ",h[s]),h[s]!==t[s])return void this.log("-- ** NOT MATCH, DROP THE PROCESS ** --");this.log("-- REVERT --"),this.log(h),c.value=a.deepClone(h.value),c[s]=h[s],c.edits=[]}var f=t.edits.filter((function(e){return e[l]>=c[l]}));if(f.length>0){var p,d=f.map((function(e){return e.patch})),y=[],v=_createForOfIteratorHelper(d);try{for(v.s();!(p=v.n()).done;){var g=p.value;if(g.length>0){var b,_=_createForOfIteratorHelper(g);try{for(_.s();!(b=_.n()).done;){var k=b.value;y.push(k)}}catch(e){_.e(e)}finally{_.f()}c.value=i?i(c,g):a.applyPatch(c.value,g).newDocument}c[l]++}}catch(e){v.e(e)}finally{v.f()}u&&(h[s]=c[s],h[l]=c[l]),this.clearOldEdits(c,t[s]),y.length>0&&(u&&(h.value=a.deepClone(c.value)),n(d,y,c[s])),this.log("***RESULT****"),this.log("shadow: ",c),o&&o(c[l]),this.log("**********")}else this.log("**XXX* not match "+l)}},{key:"onSend",value:function(e){var t,r=e.container,n=e.mainText,o=e.whenSend,i=e.whenUnchange,a=r.shadow,s=this.jsonpatch,l=this.thisVersion,u=this.senderVersion,c=s.compare(a.value,n);c.length>0?(a.edits.push((_defineProperty(t={},l,a[l]),_defineProperty(t,"patch",c),t)),a.value=s.deepClone(n),a[l]++,o(a[u],a.edits)):i&&i(a[u])}},{key:"onAck",value:function(e,t){var r=e.backup,n=e.shadow,o=this.thisVersion;this.jsonpatch;this.log("--- ON ACK ---"),this.log("Receive version: ",t[o]),this.log("Shadow version: ",n[o]),this.log("Backup version: ",r[o]),this.clearOldEdits(n,t[o])}},{key:"clearOldEdits",value:function(e,t){var r=this;e.edits=e.edits.filter((function(e){return e[r.thisVersion]>t}))}},{key:"strPatch",value:function(e,t){var r=this.jsonpatch.applyPatch(e.split(""),t).newDocument;return"string"==typeof r?r:r.join("")}}]),e}();
//# sourceMappingURL=/sm/39d6e24ad172e4912552278274f30ccf0834eca231599fe87008f6fad678e4bc.map